<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="计算机视觉,深度学习," />





  <link rel="alternate" href="/atom.html" title="LHJ's Blog" type="application/atom+xml" />






<meta name="description" content="目标检测导言干货 | 目标检测入门，看这篇就够了（已更完） 1.1 分类将图像结构化为某一类别的信息，用事先确定好的类别 (string) 或实例 ID 来描述图片。这一任务是最简单、最基础的图像理解任务，也是深度学习模型最先取得突破和实现大规模应用的任务。其中，ImageNet 是最权威的评测集，每年的 ILSVRC 催生了大量的优秀深度网络结构，为其他任务提供了基础。在应用领域，人脸、场景的识">
<meta property="og:type" content="article">
<meta property="og:title" content="目标检测">
<meta property="og:url" content="http://lihongjing.top/2019/09/20/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/index.html">
<meta property="og:site_name" content="LHJ&#39;s Blog">
<meta property="og:description" content="目标检测导言干货 | 目标检测入门，看这篇就够了（已更完） 1.1 分类将图像结构化为某一类别的信息，用事先确定好的类别 (string) 或实例 ID 来描述图片。这一任务是最简单、最基础的图像理解任务，也是深度学习模型最先取得突破和实现大规模应用的任务。其中，ImageNet 是最权威的评测集，每年的 ILSVRC 催生了大量的优秀深度网络结构，为其他任务提供了基础。在应用领域，人脸、场景的识">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-e3b665a096db8032879742d1c4ba1b5e_hd.jpg">
<meta property="article:published_time" content="2019-09-20T15:24:08.000Z">
<meta property="article:modified_time" content="2020-02-24T07:57:48.380Z">
<meta property="article:author" content="Hongjing Li">
<meta property="article:tag" content="计算机视觉">
<meta property="article:tag" content="深度学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic3.zhimg.com/80/v2-e3b665a096db8032879742d1c4ba1b5e_hd.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'Y3SEYPJSJN',
      apiKey: '',
      indexName: 'searchIndex',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://lihongjing.top/2019/09/20/目标检测/"/>





  <title>目标检测 | LHJ's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a9a282991826c1b2aee26840c3a2c139";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">LHJ's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">To strive, to seek, to find, and not to yield</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-nlp">
          <a href="/nlp" rel="section">
            
            nlp
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lihongjing.top/2019/09/20/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hongjing Li">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LHJ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">目标检测</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-20T23:24:08+08:00">
                2019-09-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CV/" itemprop="url" rel="index">
                    <span itemprop="name">CV</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/09/20/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/09/20/目标检测/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <span class="post-meta-divider">|</span>
            <span id="busuanzi_value_page_pv"></span>次阅读
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="目标检测导言"><a href="#目标检测导言" class="headerlink" title="目标检测导言"></a>目标检测导言</h1><p><a href="https://zhuanlan.zhihu.com/p/34142321" target="_blank" rel="noopener">干货 | 目标检测入门，看这篇就够了（已更完）</a></p>
<h2 id="1-1-分类"><a href="#1-1-分类" class="headerlink" title="1.1 分类"></a>1.1 分类</h2><p>将图像结构化为某一类别的信息，用事先确定好的类别 (string) 或实例 ID 来描述图片。这一任务是最简单、最基础的图像理解任务，也是深度学习模型最先取得突破和实现大规模应用的任务。其中，ImageNet 是最权威的评测集，每年的 ILSVRC 催生了大量的优秀深度网络结构，为其他任务提供了基础。在应用领域，人脸、场景的识别等都可以归为分类任务。</p>
<h2 id="1-2-检测"><a href="#1-2-检测" class="headerlink" title="1.2 检测"></a>1.2 检测</h2><p>分类任务关心整体，给出的是整张图片的内容描述，而检测则关注特定的物体目标，要求同时获得这一目标的类别信息和位置信息。相比分类，检测给出的是对图片前景和背景的理解，我们需要从背景中分离出感兴趣的目标，并确定这一目标的描述（类别和位置），因而，检测模型的输出是一个列表，列表的每一项使用一个数据组给出检出目标的类别和位置（常用矩形检测框的坐标表示）。</p>
<h2 id="1-3-分割"><a href="#1-3-分割" class="headerlink" title="1.3 分割"></a>1.3 分割</h2><p>分割包括语义分割（semantic segmentation）和实例分割（instance segmentation），前者是对前背景分离的拓展，要求分离开具有不同语义的图像部分，而后者是检测任务的拓展，要求描述出目标的轮廓（相比检测框更为精细）。分割是对图像的像素级描述，它赋予每个像素类别（实例）意义，适用于理解要求较高的场景，如无人驾驶中对道路和非道路的分割。</p>
<h1 id="目标检测经典工作"><a href="#目标检测经典工作" class="headerlink" title="目标检测经典工作"></a>目标检测经典工作</h1><a id="more"></a>

<h2 id="两阶段（2-stage）检测模型"><a href="#两阶段（2-stage）检测模型" class="headerlink" title="两阶段（2-stage）检测模型"></a>两阶段（2-stage）检测模型</h2><p>两阶段模型因其对图片的两阶段处理得名，也称为基于区域（Region-based）的方法，我们选取 R-CNN 系列工作作为这一类型的代表。</p>
<h2 id="R-CNN-R-CNN-系列的开山之作"><a href="#R-CNN-R-CNN-系列的开山之作" class="headerlink" title="R-CNN: R-CNN 系列的开山之作"></a><strong>R-CNN: R-CNN 系列的开山之作</strong></h2><p>论文链接： <a href="https://arxiv.org/abs/1311.2524" target="_blank" rel="noopener">Rich feature hierarchies for accurate object detection and semantic segmentation</a></p>
<p>本文的两大贡献：</p>
<p>1）CNN 可用于基于区域的定位和分割物体；</p>
<p>2）监督训练样本数紧缺时，在额外的数据上预训练的模型经过 fine-tuning 可以取得很好的效果。</p>
<p>第一个贡献影响了之后几乎所有2-stage方法，而第二个贡献中用分类任务（Imagenet）中训练好的模型作为基网络，在检测问题上 fine-tuning 的做法也在之后的工作中一直沿用。</p>
<p>传统的计算机视觉方法常用精心设计的手工特征 (如 SIFT, HOG) 描述图像，而深度学习的方法则倡导习得特征，从图像分类任务的经验来看，CNN 网络自动习得的特征取得的效果已经超出了手工设计的特征。本篇在局部区域应用卷积网络，以发挥卷积网络学习高质量特征的能力。</p>
<p>R-CNN网络结构</p>
<p>R-CNN 将检测抽象为两个过程，一是基于图片提出若干可能包含物体的区域（即图片的局部裁剪，被称为 Region Proposal），文中使用的是 Selective Search 算法；二是在提出的这些区域上运行当时表现最好的分类网络（AlexNet），得到每个区域内物体的类别。</p>
<h2 id="目标检测之Selective-search原理简述"><a href="#目标检测之Selective-search原理简述" class="headerlink" title="目标检测之Selective search原理简述"></a>目标检测之Selective search原理简述</h2><p>物体候选框获取当前主要使用图像分割与区域生长技术。</p>
<p>区域生长 (合并) 主要由于检测图像中存在的物体具有局部区域相似性 (颜色、纹理等)。</p>
<p>目标识别与图像分割技术的发展进一步推动有效提取图像中信息。 滑窗法作为一种经典的物体检测方法，个人认为不同大小的窗口在图像上进行滑动时候，进行卷积运算后的结果与已经训练好的分类器判别存在物体的概率。选择性搜索 (Selective Search) 是主要运用图像分割技术来进行物体检测。</p>
<h3 id="滑窗法"><a href="#滑窗法" class="headerlink" title="滑窗法"></a>滑窗法</h3><p>滑窗法的物体检测流程图：</p>
<p>通过滑窗法流程图可以很清晰理解其主要思路：首先对输入图像进行不同窗口大小的滑窗进行从左往右、从上到下的滑动。每次滑动时候对当前窗口执行分类器 (分类器是事先训练好的)。如果当前窗口得到较高的分类概率，则认为检测到了物体。对每个不同窗口大小的滑窗都进行检测后，会得到不同窗口检测到的物体标记，这些窗口大小会存在重复较高的部分，最后采用 非极大值抑制 (Non-Maximum Suppression, NMS) 的方法进行筛选。最终，经过 NMS 筛选后获得检测到的物体。</p>
<p>滑窗法简单易于理解，但是不同窗口大小进行图像全局搜索导致效率低下，而且设计窗口大小时候还需要考虑物体的长宽比。所以，对于实时性要求较高的分类器，不推荐使用滑窗法。</p>
<h3 id="选择搜索selective-search"><a href="#选择搜索selective-search" class="headerlink" title="选择搜索selective search"></a>选择搜索selective search</h3><p>滑窗法类似穷举进行图像子区域搜索，但是一般情况下图像中大部分子区域是没有物体的。学者们自然而然想到只对图像中最有可能包含物体的区域进行搜索以此来提高计算效率。选择搜索方法是当下最为熟知的图像 bouding boxes 提取算法，由 Koen E.A 于 2011 年提出，具体详见论文。下面大致说一下选择搜索算法的过程：</p>
<p>选择搜索算法的主要观点：图像中物体可能存在的区域应该是有某些相似性或者连续性区域的。因此，选择搜索基于上面这一想法采用子区域合并的方法进行提取 bounding boxes 候选边界框。首先，对输入图像进行分割算法产生许多小的子区域。其次，根据这些子区域之间相似性 <strong>(相似性标准主要有颜色、纹理、大小等等)</strong> 进行区域合并，不断的进行区域迭代合并。每次迭代过程中对这些合并的子区域做 bounding boxes (外切矩形)，这些子区域外切矩形就是通常所说的候选框。</p>
<p><strong>选择搜索优点：</strong></p>
<p>计算效率优于滑窗法。　由于采用子区域合并策略，所以可以包含各种大小的疑似物体框。　合并区域相似的指标多样性，提高了检测物体的概率。</p>
<p>一是数据的准备。输入 CNN 前，我们需要根据 Ground Truth 对提出的 Region Proposal 进行标记，这里使用的指标是 IoU（Intersection over Union，交并比）。IoU 计算了两个区域之交的面积跟它们之并的比，描述了两个区域的重合程度。</p>
<p>文章中特别提到，IoU 阈值的选择对结果影响显著，这里要谈两个 threshold，一个用来识别正样本（如跟 ground truth 的 IoU 大于 0.5），另一个用来标记负样本（即背景类，如 IoU 小于 0.1），而介于两者之间的则为难例（Hard Negatives），若标为正类，则包含了过多的背景信息，反之又包含了要检测物体的特征，因而这些 Proposal 便被忽略掉。</p>
<p>另一点是位置坐标的回归（Bounding-Box Regression），这一过程是 Region Proposal 向 Ground Truth 调整，实现时加入了 log/exp 变换来使损失保持在合理的量级上，可以看做一种标准化（Normalization) 操作。</p>
<h2 id="R-CNN小结"><a href="#R-CNN小结" class="headerlink" title="R-CNN小结"></a>R-CNN<strong>小结</strong></h2><p>R-CNN 的想法直接明了，即将检测任务转化为区域上的分类任务，是深度学习方法在检测任务上的试水。模型本身存在的问题也很多，如需要训练三个不同的模型（proposal, classification, regression）、重复计算过多导致的性能问题等。尽管如此，这篇论文的很多做法仍然广泛地影响着检测任务上的深度模型革命，后续的很多工作也都是针对改进这一工作而展开，此篇可以称得上 “The First Paper”。</p>
<h2 id="Fast-R-CNN-共享卷积运算"><a href="#Fast-R-CNN-共享卷积运算" class="headerlink" title="Fast R-CNN: 共享卷积运算"></a><strong>Fast R-CNN: 共享卷积运算</strong></h2><p>论文链接：<a href="https://arxiv.org/abs/1504.08083" target="_blank" rel="noopener">Fast R-CNN</a></p>
<p>文章指出 R-CNN 耗时的原因是 CNN 是在每一个 Proposal 上单独进行的，没有共享计算，便提出将基础网络在图片整体上运行完毕后，再传入 R-CNN 子网络，共享了大部分计算，故有 Fast 之名。</p>
<p>上图是 Fast R-CNN 的架构。图片经过 feature extractor 得到 feature map, 同时在原图上运行 Selective Search 算法并将 RoI（Region of Interset，实为坐标组，可与 Region Proposal 混用）映射到到 feature map 上，再对每个 RoI 进行 RoI Pooling 操作便得到等长的 feature vector，将这些得到的 feature vector 进行正负样本的整理（保持一定的正负样本比例），分 batch 传入并行的 R-CNN 子网络，同时进行分类和回归，并将两者的损失统一起来。</p>
<p>动图</p>
<p>RoI Pooling 是对输入 R-CNN 子网络的数据进行准备的关键操作。我们得到的区域常常有不同的大小，在映射到 feature map 上之后，会得到不同大小的特征张量。RoI Pooling 先将 RoI 等分成目标个数的网格，再在每个网格上进行 max pooling，就得到等长的 RoI feature vector。（我的理解是：主要是在提取图片特征的时候能够共享计算）</p>
<p>文章最后的讨论也有一定的借鉴意义：</p>
<ul>
<li>multi-loss traing 相比单独训练 classification 确有提升</li>
<li>multi-scale 相比 single-scale 精度略有提升，但带来的时间开销更大。一定程度上说明 CNN 结构可以内在地学习尺度不变性</li>
<li>在更多的数据 (VOC) 上训练后，精度是有进一步提升的</li>
<li>Softmax 分类器比 “one vs rest” 型的 SVM 表现略好，引入了类间的竞争</li>
<li>更多的 Proposal 并不一定带来精度的提升</li>
</ul>
<h2 id="Fast-R-CNN-小结"><a href="#Fast-R-CNN-小结" class="headerlink" title="Fast R-CNN 小结"></a>Fast R-CNN <strong>小结</strong></h2><p>Fast R-CNN 的这一结构正是检测任务主流 2-stage 方法所采用的元结构的雏形。文章将 Proposal, Feature Extractor, Object Classification&amp;Localization 统一在一个整体的结构中，并通过共享卷积计算提高特征利用效率，是最有贡献的地方。</p>
<h2 id="Faster-R-CNN-两阶段模型的深度化"><a href="#Faster-R-CNN-两阶段模型的深度化" class="headerlink" title="Faster R-CNN: 两阶段模型的深度化"></a>Faster R-CNN: 两阶段模型的深度化</h2><p>论文链接：<a href="https://arxiv.org/abs/1506.01497" target="_blank" rel="noopener">Faster R-CNN: Towards Real Time Object Detection with Region Proposal Networks</a></p>
<p>Faster R-CNN 是 2-stage 方法的奠基性工作，提出的 RPN 网络取代 Selective Search 算法使得检测任务可以由神经网络端到端地完成。粗略的讲，Faster R-CNN = RPN + Fast R-CNN，跟 RCNN 共享卷积计算的特性使得 RPN 引入的计算量很小，使得 Faster R-CNN 可以在单个 GPU 上以 5fps 的速度运行，而在精度方面达到 SOTA（State of the Art，当前最佳）。</p>
<p>本文的主要贡献是提出 Regional Proposal Networks，替代之前的 SS 算法。RPN 网络将 Proposal 这一任务建模为二分类（是否为物体）的问题。</p>
<p>第一步是在一个滑动窗口上生成不同大小和长宽比例的 anchor box（如上图右边部分），取定 IoU 的阈值，按 Ground Truth 标定这些 anchor box 的正负。于是，传入 RPN 网络的样本数据被整理为 anchor box（坐标）和每个 anchor box 是否有物体（二分类标签）。RPN 网络将每个样本映射为一个概率值和四个坐标值，概率值反应这个 anchor box 有物体的概率，四个坐标值用于回归定义物体的位置。最后将二分类和坐标回归的损失统一起来，作为 RPN 网络的目标训练。</p>
<p>由 RPN 得到 Region Proposal 在根据概率值筛选后经过类似的标记过程，被传入 R-CNN 子网络，进行多分类和坐标回归，同样用多任务损失将二者的损失联合。</p>
<h2 id="Faster-R-CNN小结"><a href="#Faster-R-CNN小结" class="headerlink" title="Faster R-CNN小结"></a>Faster R-CNN<strong>小结</strong></h2><p>Faster R-CNN 的成功之处在于用 RPN 网络完成了检测任务的 “深度化”。使用滑动窗口生成 anchor box 的思想也在后来的工作中越来越多地被采用（YOLO v2 等）。这项工作奠定了 “RPN+RCNN” 的两阶段方法元结构，影响了大部分后续工作。</p>
<h2 id="单阶段（1-stage）检测模型"><a href="#单阶段（1-stage）检测模型" class="headerlink" title="单阶段（1-stage）检测模型"></a><strong>单阶段（1-stage）检测模型</strong></h2><p>单阶段模型没有中间的区域检出过程，直接从图片获得预测结果，也被成为 Region-free 方法。</p>
<h2 id="YOLO"><a href="#YOLO" class="headerlink" title="YOLO"></a><strong>YOLO</strong></h2><p>论文链接：<a href="https://arxiv.org/abs/1506.02640" target="_blank" rel="noopener">You Only Look Once: Unified, Real-Time Object Detection</a></p>
<p>YOLO 是单阶段方法的开山之作。它将检测任务表述成一个统一的、端到端的回归问题，并且以只处理一次图片同时得到位置和分类而得名。</p>
<h3 id="YOLO-的主要优点"><a href="#YOLO-的主要优点" class="headerlink" title="YOLO 的主要优点"></a>YOLO 的主要优点</h3><ul>
<li>快。</li>
<li>全局处理使得背景错误相对少，相比基于局部（区域）的方法， 如 Fast RCNN。</li>
<li>泛化性能好，在艺术作品上做检测时，YOLO 表现比 Fast R-CNN 好。</li>
</ul>
<h3 id="YOLO-的工作流程"><a href="#YOLO-的工作流程" class="headerlink" title="YOLO 的工作流程"></a>YOLO 的工作流程</h3><ol>
<li>准备数据：将图片缩放，划分为等分的网格，每个网格按跟 Ground Truth 的 IoU 分配到所要预测的样本。</li>
<li>卷积网络：由 GoogLeNet 更改而来，每个网格对每个类别预测一个条件概率值，并在网格基础上生成 B 个 box，每个 box 预测五个回归值，四个表征位置，第五个表征这个 box 含有物体（注意不是某一类物体）的概率和位置的准确程度（由 IoU 表示）。测试时，分数如下计算：</li>
</ol>
<p><img src="https://pic3.zhimg.com/80/v2-e3b665a096db8032879742d1c4ba1b5e_hd.jpg" alt="img"></p>
<p>等式左边第一项由网格预测，后两项由每个 box 预测，以条件概率的方式得到每个 box 含有不同类别物体的分数。 因而，卷积网络共输出的预测值个数为 S×S×(B×5+C)，其中 S 为网格数，B 为每个网格生成 box 个数，C 为类别数。</p>
<ol>
<li>后处理：使用 NMS（Non-Maximum Suppression，非极大抑制）过滤得到最后的预测框</li>
</ol>
<h3 id="损失函数的设计"><a href="#损失函数的设计" class="headerlink" title="损失函数的设计"></a>损失函数的设计</h3><p>损失函数被分为三部分：坐标误差、物体误差、类别误差。为了平衡类别不均衡和大小物体等带来的影响，损失函数中添加了权重并将长宽取根号。</p>
<h3 id="YOLO小结"><a href="#YOLO小结" class="headerlink" title="YOLO小结"></a>YOLO<strong>小结</strong></h3><p>YOLO 提出了单阶段的新思路，相比两阶段方法，其速度优势明显，实时的特性令人印象深刻。但 YOLO 本身也存在一些问题，如划分网格较为粗糙，每个网格生成的 box 个数等限制了对小尺度物体和相近物体的检测。</p>
<h2 id="SSD-Single-Shot-Multibox-Detector"><a href="#SSD-Single-Shot-Multibox-Detector" class="headerlink" title="SSD: Single Shot Multibox Detector"></a>SSD: Single Shot Multibox Detector</h2><p>SSD 相比 YOLO 有以下突出的特点：</p>
<ul>
<li>多尺度的 feature map：基于 VGG 的不同卷积段，输出 feature map 到回归器中。这一点试图提升小物体的检测精度。</li>
<li>更多的 anchor box，每个网格点生成不同大小和长宽比例的 box，并将类别预测概率基于 box 预测（YOLO 是在网格上），得到的输出值个数为 (C+4)×k×m×n，其中 C 为类别数，k 为 box 个数，m×n 为 feature map 的大小。</li>
</ul>
<h3 id="SSD小结"><a href="#SSD小结" class="headerlink" title="SSD小结"></a>SSD小结</h3><p>SSD 是单阶段模型早期的集大成者，达到跟接近两阶段模型精度的同时，拥有比两阶段模型快一个数量级的速度。后续的单阶段模型工作大多基于 SSD 改进展开。</p>
<h1 id="检测模型基本特点"><a href="#检测模型基本特点" class="headerlink" title="检测模型基本特点"></a>检测模型基本特点</h1><p>检测模型整体上由基础网络（Backbone Network）和检测头部（Detection Head）构成。前者作为特征提取器，给出图像不同大小、不同抽象层次的表示；后者则依据这些表示和监督信息学习类别和位置关联。检测头部负责的类别预测和位置回归两个任务常常是并行进行的，构成多任务的损失进行联合训练。</p>
<p>相比单阶段，两阶段检测模型通常含有一个串行的头部结构，即完成前背景分类和回归后，把中间结果作为 RCNN 头部的输入再进行一次多分类和位置回归。这种设计带来了一些优点：</p>
<ul>
<li>对检测任务的解构，先进行前背景的分类，再进行物体的分类，这种解构使得监督信息在不同阶段对网络参数的学习进行指导</li>
<li>RPN 网络为 RCNN 网络提供良好的先验，并有机会整理样本的比例，减轻 RCNN 网络的学习负担</li>
</ul>
<p>这种设计的缺点也很明显：中间结果常常带来空间开销，而串行的方式也使得推断速度无法跟单阶段相比；级联的位置回归则会导致 RCNN 部分的重复计算（如两个 RoI 有重叠）。</p>
<p>另一方面，单阶段模型只有一次类别预测和位置回归，卷积运算的共享程度更高，拥有更快的速度和更小的内存占用。读者将会在接下来的文章中看到，两种类型的模型也在互相吸收彼此的优点，这也使得两者的界限更为模糊。</p>
<p>在下一篇中，我们将介绍检测模型的评测指标与评测数据集，并总结常用的训练和建模技巧。</p>
<h1 id="模型的评测与训练技巧"><a href="#模型的评测与训练技巧" class="headerlink" title="模型的评测与训练技巧"></a>模型的评测与训练技巧</h1><h2 id="检测模型的评测指标"><a href="#检测模型的评测指标" class="headerlink" title="检测模型的评测指标"></a>检测模型的评测指标</h2><p>目标检测模型本源上可以用统计推断的框架描述，我们关注其犯第一类错误和第二类错误的概率，通常用准确率和召回率来描述。准确率描述了模型有多准，即在预测为正例的结果中，有多少是真正例；召回率则描述了模型有多全，即在为真的样本中，有多少被我们的模型预测为正例。不同的任务，对两类错误有不同的偏好，常常在某一类错误不多于一定阈值的情况下，努力减少另一类错误。在检测中，mAP（mean Average Precision）作为一个统一的指标将这两种错误兼顾考虑。</p>
<p>具体地，对于每张图片，检测模型输出多个预测框（常常远超真实框的个数），我们使用IoU（Intersection Over Union，交并比）来标记预测框是否为预测正确。标记完成后，随着预测框的增多，召回率总会提升，在不同的召回率水平下对准确率做平均，即得到AP，最后再对所有类别按其所占比例做平均，即得到mAP。</p>
<p>在较早的Pascal VOC数据集上，常采用固定的一个IoU阈值（如0.5, 0.75）来计算mAP，现阶段较为权威的MS COCO数据集上，对不同的IoU阈值（0.5-0.95，0.05为步长）分别计算AP，再综合平均，并且给出了不同大小物体分别的AP表现，对定位准确的模型给予奖励并全面地展现不同大小物体上检测算法的性能，更为科学合理。</p>
<p>在实践中，我们不仅关注检测模型的精度，还关注其运行的速度，常常用FPS（Frame Per Second，每秒帧率）来表示检测模型能够在指定硬件上每秒处理图片的张数。通常来讲，在单块GPU上，两阶段方法的FPS一般在个位数，而单阶段方法可以达到数十。现在检测模型运行的平台并不统一，实践中也不能部署较为昂贵的GPU进行推断。事实上，很多文章并没有严谨讨论其提出模型的速度表现（加了较多的trick以使精度达到SOTA），另外，考虑到目前移动端专用芯片的发展速度和研究进展，速度方面的指标可能较难形成统一的参考标准，需要谨慎看待文章中汇报的测试结果。</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Donate comment here</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="Hongjing Li 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Hongjing Li 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/" rel="tag"># 计算机视觉</a>
          
            <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag"># 深度学习</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/header.jpg"
                alt="Hongjing Li" />
            
              <p class="site-author-name" itemprop="name">Hongjing Li</p>
              <p class="site-description motion-element" itemprop="description">李弘靖的个人博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.html" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/donttal" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/qing-kong-liu-li-87/activities" target="_blank" title="Zhihu">
                      
                        <i class="fa fa-fw fa-globe"></i>Zhihu</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#目标检测导言"><span class="nav-text">目标检测导言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-分类"><span class="nav-text">1.1 分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-检测"><span class="nav-text">1.2 检测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-分割"><span class="nav-text">1.3 分割</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#目标检测经典工作"><span class="nav-text">目标检测经典工作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#两阶段（2-stage）检测模型"><span class="nav-text">两阶段（2-stage）检测模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#R-CNN-R-CNN-系列的开山之作"><span class="nav-text">R-CNN: R-CNN 系列的开山之作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目标检测之Selective-search原理简述"><span class="nav-text">目标检测之Selective search原理简述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#滑窗法"><span class="nav-text">滑窗法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#选择搜索selective-search"><span class="nav-text">选择搜索selective search</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#R-CNN小结"><span class="nav-text">R-CNN小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fast-R-CNN-共享卷积运算"><span class="nav-text">Fast R-CNN: 共享卷积运算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fast-R-CNN-小结"><span class="nav-text">Fast R-CNN 小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Faster-R-CNN-两阶段模型的深度化"><span class="nav-text">Faster R-CNN: 两阶段模型的深度化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Faster-R-CNN小结"><span class="nav-text">Faster R-CNN小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#单阶段（1-stage）检测模型"><span class="nav-text">单阶段（1-stage）检测模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YOLO"><span class="nav-text">YOLO</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#YOLO-的主要优点"><span class="nav-text">YOLO 的主要优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YOLO-的工作流程"><span class="nav-text">YOLO 的工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#损失函数的设计"><span class="nav-text">损失函数的设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YOLO小结"><span class="nav-text">YOLO小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SSD-Single-Shot-Multibox-Detector"><span class="nav-text">SSD: Single Shot Multibox Detector</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SSD小结"><span class="nav-text">SSD小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#检测模型基本特点"><span class="nav-text">检测模型基本特点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模型的评测与训练技巧"><span class="nav-text">模型的评测与训练技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#检测模型的评测指标"><span class="nav-text">检测模型的评测指标</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hongjing Li</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>


<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv" style='display:none'>
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    有<span id="busuanzi_value_site_uv"></span>人看过我的博客
</span>
</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://lihongjing.top/2019/09/20/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/';
          this.page.identifier = '2019/09/20/目标检测/';
          this.page.title = '目标检测';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
